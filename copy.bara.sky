# copy.bara.sky

# Download Copybara .jar file from
# https://github.com/google/copybara/releases

# Set this in your shell profile (e.g. .bashrc)
# echo "COPYBARA_DEPLOY_JAR=${HOME}/tools/copybara_deploy.jar" >> ~/.bashrc

# Run workflows locally (initial, dry run)
# java -jar $COPYBARA_DEPLOY_JAR copy.bara.sky backend_sync --init-history --force --dry-run
# java -jar $COPYBARA_DEPLOY_JAR copy.bara.sky frontend_sync --init-history --force --dry-run

# Run workflows locally (initial run)
# java -jar $COPYBARA_DEPLOY_JAR copy.bara.sky backend_sync --init-history --force
# java -jar $COPYBARA_DEPLOY_JAR copy.bara.sky frontend_sync --init-history --force

# Run workflows locally (subsequent runs, these could be automated)
# java -jar $COPYBARA_DEPLOY_JAR copy.bara.sky backend_sync
# java -jar $COPYBARA_DEPLOY_JAR copy.bara.sky frontend_sync

# -----------------------------------------------------------------------------
# VARIABLES
# -----------------------------------------------------------------------------
FE_REPO_URL = "https://partner-code.googlesource.com/agent-assist-ui-modules"
BE_REPO_URL = "https://partner-code.googlesource.com/aa-integration-backend"
GITHUB_URL  = "https://github.com/GoogleCloudPlatform/agent-assist-integrations"

# -----------------------------------------------------------------------------
# WORKFLOW 1: Frontend (Root to Root)
# -----------------------------------------------------------------------------
core.workflow(
    name = "frontend_sync",
    origin = git.origin(
        url = FE_REPO_URL,
        ref = "main", # Gerrit BE default branch
    ),
    destination = git.destination(
        url = GITHUB_URL,
        fetch = "main", # Github default branch,
        push = "main", # GitHub default branch
    ),

    # PREVENTS DELETION OF AA-INTEGRATION-BACKEND/ IN GITHUB
    destination_files = glob(["**"], exclude = ["aa-integration-backend/**", "copy.bara.sky"]),

    mode = "ITERATIVE",
    authoring = authoring.pass_thru("Copybara <noreply@google.com>"),
)

# -----------------------------------------------------------------------------
# WORKFLOW 2: Backend (Root to Subfolder)
# -----------------------------------------------------------------------------
core.workflow(
    name = "backend_sync",
    origin = git.origin(
        url = BE_REPO_URL,
        ref = "main", # Gerrit BE default branch
    ),
    destination = git.destination(
        url = GITHUB_URL,
        fetch = "main", # Github default branch,
        push = "main", # Github default branch
    ),

    destination_files = glob(["aa-integration-backend/**"]),

    mode = "ITERATIVE",
    authoring = authoring.pass_thru("Copybara <noreply@google.com>"),

    # MAP ROOT FOLDER TO SUBFOLDER IN GITHUB
    transformations = [
        core.move("", "aa-integration-backend"),
    ],
)