# See Makefile for regular usage instructions. 

# Download Copybara .jar file from
# https://github.com/google/copybara/releases

# For initial migration, use this command (test with --dry-run first):
# java -jar $COPYBARA_DEPLOY_JAR migrate copy.bara.sky backend_sync --init-history --force --dry-run --last-rev <commit-sha>
# java -jar $COPYBARA_DEPLOY_JAR migrate copy.bara.sky frontend_sync --init-history --force --dry-run --last-rev <commit-sha>

# -----------------------------------------------------------------------------
# VARIABLES
# -----------------------------------------------------------------------------
FE_REPO_URL = "https://partner-code.googlesource.com/agent-assist-ui-modules"
BE_REPO_URL = "https://partner-code.googlesource.com/aa-integration-backend"
GITHUB_URL  = "https://github.com/GoogleCloudPlatform/agent-assist-integrations/"

# -----------------------------------------------------------------------------
# WORKFLOW 1: Frontend (Root to Root)
# -----------------------------------------------------------------------------
core.workflow(
    name = "frontend_sync",
    origin = git.origin(
        url = FE_REPO_URL,
        ref = "main", # Gerrit BE default branch
    ),
    destination = git.destination(
        url = GITHUB_URL,
        fetch = "main", # Github default branch,
        push = "main", # GitHub default branch
    ),

    # PREVENTS DELETION OF AA-INTEGRATION-BACKEND/ IN GITHUB
    destination_files = glob(["**"], exclude = ["aa-integration-backend/**", "copy.bara.sky"]),

    mode = "ITERATIVE",
    authoring = authoring.pass_thru("Copybara <noreply@google.com>"),
)

# -----------------------------------------------------------------------------
# WORKFLOW 2: Backend (Root to Subfolder)
# -----------------------------------------------------------------------------
core.workflow(
    name = "backend_sync",
    origin = git.origin(
        url = BE_REPO_URL,
        ref = "main", # Gerrit BE default branch
    ),
    destination = git.destination(
        url = GITHUB_URL,
        fetch = "main", # Github default branch,
        push = "main", # Github default branch
    ),

    destination_files = glob(["aa-integration-backend/**"]),

    mode = "ITERATIVE",
    authoring = authoring.pass_thru("Copybara <noreply@google.com>"),

    # MAP ROOT FOLDER TO SUBFOLDER IN GITHUB
    transformations = [
        core.move("", "aa-integration-backend"),
    ],
)